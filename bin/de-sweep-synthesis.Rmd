---
title: "de-sweep-synthesis"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
params:
  rmd: ""
output:
  html_document:
    dev: png
    code_folding: hide
    self_contained: yes
    toc: true
    toc_depth: 5
    toc_float:
      collapsed: false
      smooth_scroll: true
    number_sections: true
    df_print: paged
---
```{r setup}
knitr::opts_chunk$set(
	echo = TRUE,
	message = FALSE,
	warning = FALSE,
	cache = TRUE
)
```

```{r load_libs}
# my packages
library(tidyverse)
library(readr)
library(vroom)
library(tibble)
```

```{r functions}
plot.volcano <- function(overlap){
  my.colors = c("#d95f02","#e6ab02","#a6cee3","#7570b3","#66a61e")
  
  df = overlap %>% 
    # add significance and logFC criteria for plotting
    dplyr::mutate(Significance = factor(case_when(
      (FDR < 0.05) & (abs(logFC) > 1) & (sweep_gene == "yes") ~ "logFC>1, FDR<0.05, & Sweep Candidate",
      (FDR < 0.05) & (abs(logFC) > 1) ~ "logFC>1 & FDR<0.05",
      (FDR > 0.05) & (abs(logFC) > 1) ~ "logFC>1 only",
      (FDR < 0.05) & (abs(logFC) < 1) ~ "FDR<0.05 only",
      (FDR > 0.05) & (abs(logFC) < 1) ~ "NS"),
      levels = c("NS",
                 "FDR<0.05 only",
                 "logFC>1 only",
                 "logFC>1 & FDR<0.05",
                 "logFC>1, FDR<0.05, & Sweep Candidate")))
    # now ggplot
    ggplot(df, aes(x=logFC, y=-log10(FDR), color=Significance, alpha = 0.7)) +
      geom_point(data = subset(df, is.na(sweep_gene)==TRUE)) +
      geom_point(data = subset(df, is.na(sweep_gene)==FALSE)) +
      scale_color_manual(values=my.colors) +
      scale_fill_manual(values=my.colors) +
      theme_light()
}

kable.overlap <- function(overlap){
  knitr::kable(overlap %>% 
               # filter only sweep genes, significant, logFC>1
               filter(FDR < 0.05,
                      abs(logFC) > 1,
                      sweep_gene == "yes") %>% 
               # select columns 
               dplyr::select(gene,logFC,FDR,`gene name`,`gene description`)) %>%
  kableExtra::kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))
}
```


```{r load_data}
# selective sweep analysis
domGene <- readxl::read_excel("../raw_data/DomGeneFinalSelections.xlsx")

# normalized LogCPM data
norm_log_cpm <- read_tsv("../deliverables/norm_log_cpm.tsv") %>% dplyr::mutate(gene=gsub("gene:","",gene))
colnames(norm_log_cpm) <- c("gene",paste0("norm_log_cpm.", colnames(norm_log_cpm)[2:ncol(norm_log_cpm)]))

# DE results
DE.root <- read_tsv("../deliverables/DE-root.tsv")
DE.shoot <- read_tsv("../deliverables/DE-shoot.tsv")
DE.node <- read_tsv("../deliverables/DE-node.tsv")
DE.leaf <- read_tsv("../deliverables/DE-leaf.tsv")
DE.meristem <- read_tsv("../deliverables/DE-meristem.tsv")
DE.earlyBudding <- read_tsv("../deliverables/DE-earlyBudding.tsv")
DE.lateBudding <- read_tsv("../deliverables/DE-lateBudding.tsv")
DE.endosperm <- read_tsv("../deliverables/DE-endosperm.tsv")
DE.seedcoat <- read_tsv("../deliverables/DE-seedcoat.tsv")
```
# Save Results

```{r}
# get overlaps
overlap.root <- dplyr::left_join(DE.root,
                                 domGene %>% dplyr::rename(gene=`gene name1`) %>% dplyr::mutate(sweep_gene=TRUE),
                                 by="gene")
overlap.shoot <- dplyr::left_join(DE.shoot, 
                                  domGene %>% dplyr::rename(gene=`gene name1`) %>% dplyr::mutate(sweep_gene=TRUE),
                                  by="gene")
overlap.node <- dplyr::left_join(DE.node, 
                                 domGene %>% dplyr::rename(gene=`gene name1`) %>% dplyr::mutate(sweep_gene=TRUE),
                                 by="gene")
overlap.leaf <- dplyr::left_join(DE.leaf,
                                 domGene %>% dplyr::rename(gene=`gene name1`) %>% dplyr::mutate(sweep_gene=TRUE),
                                 by="gene")
overlap.meristem <- dplyr::left_join(DE.meristem, 
                                     domGene %>% dplyr::rename(gene=`gene name1`) %>% dplyr::mutate(sweep_gene=TRUE),
                                     by="gene")
overlap.earlyBudding <- dplyr::left_join(DE.earlyBudding,
                                         domGene %>% dplyr::rename(gene=`gene name1`) %>% dplyr::mutate(sweep_gene=TRUE),
                                         by="gene")
overlap.endosperm <- dplyr::left_join(DE.endosperm, 
                                      domGene %>% dplyr::rename(gene=`gene name1`) %>% dplyr::mutate(sweep_gene=TRUE),
                                      by="gene")
overlap.lateBudding <- dplyr::left_join(DE.lateBudding, 
                                        domGene %>% dplyr::rename(gene=`gene name1`) %>% dplyr::mutate(sweep_gene=TRUE),
                                        by="gene")
overlap.seedcoat <- dplyr::left_join(DE.seedcoat, 
                                        domGene %>% dplyr::rename(gene=`gene name1`) %>% dplyr::mutate(sweep_gene=TRUE),
                                        by="gene")

# 
write_tsv(overlap.root, path="../deliverables/sweep-DE-overlap.root.tsv")
write_tsv(overlap.shoot, path="../deliverables/sweep-DE-overlap.shoot.tsv")
write_tsv(overlap.node, path="../deliverables/sweep-DE-overlap.node.tsv")
write_tsv(overlap.leaf, path="../deliverables/sweep-DE-overlap.leaf.tsv")
write_tsv(overlap.meristem, path="../deliverables/sweep-DE-overlap.meristem.tsv")
write_tsv(overlap.earlyBudding, path="../deliverables/sweep-DE-overlap.earlyBudding.tsv")
write_tsv(overlap.lateBudding, path="../deliverables/sweep-DE-overlap.lateBudding.tsv")
write_tsv(overlap.endosperm, path="../deliverables/sweep-DE-overlap.endosperm.tsv")
write_tsv(overlap.seedcoat, path="../deliverables/sweep-DE-overlap.shoot.tsv")
```

## domGenes Master Sheet
```{r}

domGene.plusDE <- plyr::join_all(list(
  domGene %>% dplyr::rename(gene=`gene name1`),
  overlap.root %>% dplyr::select(gene,logFC,FDR) %>% dplyr::rename(logFC.root=logFC, FDR.root=FDR),
  overlap.shoot %>% dplyr::select(gene,logFC,FDR) %>% dplyr::rename(logFC.shoot=logFC, FDR.shoot=FDR),
  overlap.node %>% dplyr::select(gene,logFC,FDR) %>% dplyr::rename(logFC.node=logFC, FDR.node=FDR),
  overlap.leaf %>% dplyr::select(gene,logFC,FDR) %>% dplyr::rename(logFC.leaf=logFC, FDR.leaf=FDR),
  overlap.meristem %>% dplyr::select(gene,logFC,FDR) %>% dplyr::rename(logFC.meristem=logFC, FDR.meristem=FDR),
  overlap.earlyBudding %>% dplyr::select(gene,logFC,FDR) %>% dplyr::rename(logFC.R1=logFC, FDR.R1=FDR),
  overlap.lateBudding %>% dplyr::select(gene,logFC,FDR) %>% dplyr::rename(logFC.R1plus5=logFC, FDR.R1plus5=FDR),
  overlap.endosperm %>% dplyr::select(gene,logFC,FDR) %>% dplyr::rename(logFC.endosperm=logFC, FDR.endosperm=FDR),
  overlap.seedcoat %>% dplyr::select(gene,logFC,FDR) %>% dplyr::rename(logFC.seedcoat=logFC, FDR.seedcoat=FDR),
  norm_log_cpm), 
  by="gene", type="left") %>% unique()

write_tsv(domGene.plusDE,"../deliverables/domGeneFinalSelections.plusDE.tsv")
```


# DE by Tissue

## Root
```{r}
plot.volcano(overlap.root)
kable.overlap(overlap.root)
```

## Shoot
```{r}
plot.volcano(overlap.shoot)
kable.overlap(overlap.shoot)
```

## Node
```{r}
plot.volcano(overlap.node)
kable.overlap(overlap.node)
```

## Leaf
```{r}
plot.volcano(overlap.leaf)
kable.overlap(overlap.leaf)
```

## Meristem
```{r}
plot.volcano(overlap.meristem)
kable.overlap(overlap.meristem)
```

## Early Budding
```{r}
plot.volcano(overlap.earlyBudding)
kable.overlap(overlap.earlyBudding)
```

## Late Budding
```{r}
plot.volcano(overlap.lateBudding)
kable.overlap(overlap.lateBudding)
```

## Endosperm
```{r}
plot.volcano(overlap.endosperm)
kable.overlap(overlap.endosperm)
```

## Seedcoat
```{r}
plot.volcano(overlap.seedcoat)
kable.overlap(overlap.seedcoat)
```

# sessionInfo
```{r}
sessionInfo()
```

